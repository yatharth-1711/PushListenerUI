using MeterReader.DLMSInterfaceClasses.ActionSchedule;
using MeterReader.DLMSInterfaceClasses.PushSetup;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Text.RegularExpressions;
using System.Windows.Forms;

namespace MeterReader.DLMSInterfaceClasses
{
    public partial class PushSetupandActionScheduleConfig : Form
    {
        public PushSetupandActionScheduleConfig()
        {
            InitializeComponent();
            LoadData();
        }
        private void LoadData()
        {
            try
            {
                cmbObjectType.Items.AddRange(new object[]
                {
                    "--Select Object Type --",
                    "Action Schedule",
                    "Push Setup"
                });
                cmbObjectType.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show("LoadData", ex.Message);
            }
        }
        private void cmbObjectType_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                cmbObject.Enabled = false;
                cmbObject.DataSource = null;
                txtClassId.Clear();
                txtCurrentObis.Clear();
                txtNewObis.Clear();
                if (cmbObjectType.Text == "Push Setup")
                {
                    cmbObject.DataSource = Enum.GetValues(typeof(PushSetupObisCodes.PushSetupObject)); txtClassId.Text = "40"; cmbObject.Enabled = true;
                }
                else if (cmbObjectType.Text == "Action Schedule")
                {
                    cmbObject.DataSource = Enum.GetValues(typeof(ActionScheduleObisCodes.ActionScheduleObject)); txtClassId.Text = "22"; cmbObject.Enabled = true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("cmbObjectType_SelectedIndexChanged", ex.Message);
            }
        }
        private void cmbObject_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                if (cmbObject.SelectedItem == null)
                    return;

                if (cmbObjectType.Text == "Push Setup" && cmbObject.SelectedItem is PushSetupObisCodes.PushSetupObject pushObj)
                {
                    txtCurrentObis.Text = PushSetupObisCodes.Get(pushObj);
                }
                else if (cmbObjectType.Text == "Action Schedule" && cmbObject.SelectedItem is ActionScheduleObisCodes.ActionScheduleObject actionObj)
                {
                    txtCurrentObis.Text = ActionScheduleObisCodes.Get(actionObj);
                }
                else
                {
                    txtCurrentObis.Clear();
                }
                txtNewObis.Clear();
                MarkValid(txtNewObis);
            }
            catch (Exception ex)
            {
                MessageBox.Show("cmbObject_SelectedIndexChanged", ex.Message);
            }
        }
        private void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                if (!IsValidObis(txtNewObis.Text))
                {
                    MarkInvalid(txtNewObis);
                    txtNewObis.Focus();
                    return;
                }
                string newObis = txtNewObis.Text.Trim();

                if (cmbObjectType.Text == "Push Setup" && cmbObject.SelectedItem is PushSetupObisCodes.PushSetupObject pushObj)
                {
                    PushSetupObisCodes.Set(pushObj, newObis);
                }
                else if (cmbObjectType.Text == "Action Schedule" && cmbObject.SelectedItem is ActionScheduleObisCodes.ActionScheduleObject actionObj)
                {
                    ActionScheduleObisCodes.Set(actionObj, newObis);
                }
                else
                {
                    return;
                }
                txtCurrentObis.Text = newObis;
                MarkValid(txtNewObis);
            }
            catch (Exception ex)
            {
                MessageBox.Show("btnSave_Click", ex.Message);
            }
        }
        private void btnReset_Click(object sender, EventArgs e)
        {
            try
            {
                if (cmbObject.SelectedItem == null)
                    return;

                if (cmbObjectType.Text == "Push Setup" && cmbObject.SelectedItem is PushSetupObisCodes.PushSetupObject pushObj)
                {
                    PushSetupObisCodes.Reset(pushObj);
                    txtCurrentObis.Text = PushSetupObisCodes.Get(pushObj);
                }
                else if (cmbObjectType.Text == "Action Schedule" && cmbObject.SelectedItem is ActionScheduleObisCodes.ActionScheduleObject actionObj)
                {
                    ActionScheduleObisCodes.Reset(actionObj);
                    txtCurrentObis.Text = ActionScheduleObisCodes.Get(actionObj);
                }
                txtNewObis.Text = txtCurrentObis.Text;
                MarkValid(txtNewObis);
            }
            catch (Exception ex)
            {
                MessageBox.Show("btnReset_Click", ex.Message);
            }
        }
        private void txtNewObis_Leave(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtNewObis.Text))
            {
                MarkValid(txtNewObis);
                return;
            }
            if (!IsValidObis(txtNewObis.Text))
            {
                MarkInvalid(txtNewObis);
                txtNewObis.Focus();
            }
            else
            {
                MarkValid(txtNewObis);
            }
        }
        private void txtNewObis_TextChanged(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtNewObis.Text))
            {
                MarkValid(txtNewObis);
                return;
            }
            if (IsValidObis(txtNewObis.Text))
                MarkValid(txtNewObis);
            else
                MarkInvalid(txtNewObis);
        }
        private bool IsValidObis(string input)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(input))
                    return false;
                input = input.Trim();
                if (Regex.IsMatch(input, @"^(0x)?[0-9A-Fa-f]{1,12}$", RegexOptions.Compiled))
                    return true;
                if (Regex.IsMatch(input, @"^(\d{1,3}\.){5}\d{1,3}$", RegexOptions.Compiled))
                    return true;
                return false;
            }
            catch
            {
                return false;
            }
        }
        private void MarkInvalid(TextBox tb)
        {
            tb.BackColor = Color.MistyRose;
            tb.ForeColor = Color.DarkRed;
        }
        private void MarkValid(TextBox tb)
        {
            tb.BackColor = SystemColors.Window;
            tb.ForeColor = SystemColors.WindowText;
        }
        private void btnCancel_Click(object sender, EventArgs e)
        {
            try
            {
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("btnCancel_Click", ex.Message);
            }
        }
    }
}
